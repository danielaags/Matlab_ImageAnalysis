clear
% 
%images = dir('*.tif');
dataF = dir('*data.mat');
radiiF = dir('*radii.mat');
pixelF = dir('*pixel.mat');
images = dir('*.tif');


%%
%Save all the info in cells.
%1. Start with labels, y, x, and growth rate
%2. The radii from different time points
%3. Finally pixel values


for i = 1:length(dataF)
    load(dataF(i).name)
    load(radiiF(i).name)
        if i == 1
        data = s;
        %For now, only collect radii from the last day
        radii30 = radii{1};
        else
            data.Label = ([data.Label; s.Label]);
            data.y = ([data.y; s.y]);
            data.x = ([data.x; s.x]);
            data.growth = ([data.growth; s.growth]);
            radii30 = [radii30;radii{1}];
        end

end

%Need to repeat for loop since I gave the struct same names, already
%CollectAllData script changed to avoid this issue and do everything in a
%single for loop. Remember to change the struct name from s > r
for i = 1:length(dataF)
    load(pixelF(i).name)
        if i == 1
        pixel = s;
        else
            pixel = [pixel; s];

        end
end

%%
%Find the centroids and collect the information as labels and radii
cy_original = data.y;
cx_original = data.x;

pixel_centroid = cat(1, pixel.Centroid);
cy_pixel = round(pixel_centroid(:,1));
cx_pixel = round(pixel_centroid(:,2));

idx_pixel = zeros(length(cy_pixel), 1);
radii_pixel = zeros(length(cy_pixel), 1);
growth_pixel = zeros(length(cy_pixel), 1);
std_pixel = zeros(length(cy_pixel), 1);
%label string will be also split to have an easier way to plot on the
%plates
label_pixel = strings(length(cy_pixel), 1);
plate_pixel = zeros(length(cy_pixel), 1);
colony_pixel = zeros(length(cy_pixel), 1);


for i = 1:length(cy_pixel)
    y = find(cy_pixel(i) == cy_original, 1);
    x = find(cx_pixel(i) == cx_original, 1);
    std_pixel(i) = std(double(pixel(i).PixelValues));
    if y == x
        idx_pixel(i)= y;
        label_pixel(i) = data.Label(y);
        radii_pixel(i) = radii30(y);
        growth_pixel(i) = data.growth(y);
        %Split the information to get a plate and colony number
        s = split(data.Label(y), '-');
        plate_pixel(i) = str2num(s(2));
        colony_pixel(i) = str2num(s(3));
    end
end

%%
%Cluster radii and std color. There are many values different from double
%in my growth array. Need better way to calculate this. However, so far I
%can have.
idx = growth_pixel > 0 & growth_pixel < Inf;
%Array between two values
X = [growth_pixel(idx) std_pixel(idx)];
[idx,C] = kmeans(X,3);
figure
gscatter(X(:,1),X(:,2),idx,'bgm')
hold on
plot(C(:,1),C(:,2),'kx')
legend('Cluster 1','Cluster 2','Cluster 3', 'Cluster Centroid')
close 

col = ['b', 'g', 'm'];
%%
%I need to re-filter the values at this step


for j = 1:length(images)
    file= images(j).name;
    I = imread(file);
    
    %Find index where the plate belongs
    temp_idx = find(plate_pixel == j);
    %Find the centroids found in that plate and the raddii for the colonies
    temp_centroid = pixel_centroid(temp_idx,:);
    temp_radii = radii_pixel(temp_idx);
    temp_cluster = idx(temp_idx);
    
    clusters = unique(temp_cluster);
    figure
    imshow(I);
    hold on
    for i = 1:length(clusters) 
        idx_c = find(temp_cluster == clusters(i));
        viscircles(temp_centroid(idx_c,:), temp_radii(idx_c), 'Color', col(clusters(i)));
    end  
    hold off
    
%     output = split(file, '.');
%     print(output{1},'-dpng');
%     close;
end




%%
%Clustering
% %Plot min vs max
X = [double([pixel.MinIntensity]'), double([pixel.MaxIntensity]')];
%plot(X, '*')
[idx,C] = kmeans(X,5);
figure
gscatter(X(:,1),X(:,2),idx,'bgmrk')
hold on
plot(C(:,1),C(:,2),'kx')
legend('Cluster 1','Cluster 2','Cluster 3', 'Cluster 4', 'Cluster 5', 'Cluster Centroid')



file= images(1).name;
I = imread(file);
col = ['b', 'g', 'm'];
figure
imshow(I);
hold on
for i = 1:3
    r = find(idx ==i);
    viscircles(centersN(r,:),radiiN(r), 'Color', col(i));
end
hold off

